<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('UniversalStyles'); ?>
  <style>
    /* Professional Dark Theme Overrides */
    .summary-section {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    .summary-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 4px;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .summary-value {
      font-size: 1.25rem;
      color: var(--primary);
      font-weight: 700;
    }

    /* Single Bin Card Focused Layout */
    .bin-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-left: 4px solid var(--primary);
      border-radius: var(--radius-md);
      padding: 24px;
      margin: 0 auto;
      max-width: 650px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .bin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .bin-code {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-main);
    }
    
    .current-info-panel {
        background: var(--bg-body);
        border: 1px dashed var(--border-color);
        border-radius: var(--radius-sm);
        padding: 12px;
        margin-bottom: 20px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    
    .info-block label {
        font-size: 0.7rem;
        color: var(--text-muted);
        text-transform: uppercase;
        display: block;
    }
    .info-block div {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-secondary);
    }

    .input-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 16px;
    }
    
    .count-section {
        background: rgba(16, 185, 129, 0.1); /* Subtle green tint */
        border: 1px solid var(--success);
        padding: 16px;
        border-radius: var(--radius-md);
        margin-top: 20px;
    }

    .count-input {
      font-size: 1.5rem;
      font-weight: 700;
      padding: 12px;
      text-align: center;
      border: 2px solid var(--border-color);
    }
    
    .count-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
    }

    /* Loading Overlay */
    .loading-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 100;
      backdrop-filter: blur(4px);
    }

    .loading-overlay.active { display: flex; }
  </style>

  <script>
    // Global state
    let binsQueue = [];
    let currentIndex = 0;
    let manufacturers = [];
    let projects = [];

    // Initialize on load
    window.onload = function() {
      setLoading(true, 'Initializing...');
      loadDependencies();
    };
    
    function loadDependencies() {
        // Chain loading dependencies: Manufacturers -> Projects -> Bins
        google.script.run.withSuccessHandler(m => {
            manufacturers = m || [];
            
            google.script.run.withSuccessHandler(p => {
                projects = p || [];
                loadCycleCount(); // Finally load bins
            }).withFailureHandler(onFailure).getProjects();
            
        }).withFailureHandler(onFailure).getManufacturers();
    }

    function loadCycleCount() {
      setLoading(true, 'Fetching bins for cycle count...');
      google.script.run
        .withSuccessHandler(onCycleCountLoaded)
        .withFailureHandler(onFailure)
        .getBinsForCycleCount({});
    }

    function onCycleCountLoaded(response) {
      setLoading(false);
      let bins = [];

      // Robust response handling
      if (Array.isArray(response)) {
        bins = response;
      } else if (response && Array.isArray(response.bins)) {
        bins = response.bins;
      } else if (response && Array.isArray(response.results)) {
        bins = response.results;
      } else if (response && response.success === false) {
        return showAlert('Error loading bins: ' + (response.message || 'Unknown error'), 'danger');
      }

      // Sort bins by Bin_Code (Alphanumeric sort)
      bins.sort((a, b) => {
          const codeA = (a.binCode || a.Bin_Code || '').toString();
          const codeB = (b.binCode || b.Bin_Code || '').toString();
          return codeA.localeCompare(codeB, undefined, {numeric: true, sensitivity: 'base'});
      });

      binsQueue = bins;
      currentIndex = 0;
      renderCurrentBin();
    }

    function renderCurrentBin() {
      const container = document.getElementById('binContent');
      const progressDiv = document.getElementById('currentRows');
      
      // Check for completion
      if (currentIndex >= binsQueue.length) {
          if (binsQueue.length === 0) {
              container.innerHTML = `
                  <div style="text-align: center; padding: 60px 20px;">
                      <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
                      <h3 style="color: var(--text-main);">No Bins Found</h3>
                      <p style="color: var(--text-muted);">No inventory bins matched the criteria.</p>
                      <button class="btn btn-primary mt-3" onclick="loadCycleCount()">Refresh</button>
                  </div>`;
              progressDiv.textContent = "0";
          } else {
              container.innerHTML = `
                  <div style="text-align: center; padding: 60px 20px;">
                      <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                      <h3 style="color: var(--text-main);">Cycle Count Complete!</h3>
                      <p style="color: var(--text-muted);">You have processed all ${binsQueue.length} bins.</p>
                      <button class="btn btn-primary mt-3" onclick="loadCycleCount()">Start New Batch</button>
                  </div>`;
              progressDiv.textContent = "Done";
          }
          return;
      }
      
      // Update Progress
      progressDiv.textContent = `${currentIndex + 1} / ${binsQueue.length}`;
      
      const bin = binsQueue[currentIndex];
      
      // Extract values with fallbacks
      const binCode = bin.binCode || bin.Bin_Code || 'Unknown';
      const curFbpn = bin.fbpn || bin.FBPN || '';
      const curMfr = bin.manufacturer || bin.Manufacturer || '';
      const curProj = bin.project || bin.Project || '';
      const curPush = bin.pushNumber || bin.Push_Number || '';
      const sysQty = bin.currentQty !== undefined ? bin.currentQty : (bin.Current_Quantity || 0);

      // Build Options for Dropdowns
      let mfrOpts = `<option value="">Select Manufacturer...</option>`;
      manufacturers.forEach(m => {
          mfrOpts += `<option value="${m}" ${m === curMfr ? 'selected' : ''}>${m}</option>`;
      });
      
      let projOpts = `<option value="">Select Project...</option>`;
      projects.forEach(p => {
          projOpts += `<option value="${p}" ${p === curProj ? 'selected' : ''}>${p}</option>`;
      });

      // Render Card
      container.innerHTML = `
        <div class="bin-card">
          <div class="bin-header">
            <div class="bin-code">${binCode}</div>
            <div style="text-align:right">
                <span class="text-muted" style="font-size:0.8rem">System Qty</span><br>
                <span style="font-size:1.2rem; font-weight:bold;">${sysQty}</span>
            </div>
          </div>
          
          <div class="current-info-panel">
             <div class="info-block"><label>Current FBPN</label><div>${curFbpn || '-'}</div></div>
             <div class="info-block"><label>Current Push #</label><div>${curPush || '-'}</div></div>
             <div class="info-block"><label>Current Mfr</label><div>${curMfr || '-'}</div></div>
             <div class="info-block"><label>Current Project</label><div>${curProj || '-'}</div></div>
          </div>

          <div class="form-section-title" style="font-size:0.9rem; margin-bottom:10px;">Correction / Verification</div>
          
          <div class="input-grid">
             <div class="form-group">
               <label class="form-label">Corrected FBPN</label>
               <input id="inputFbpn" class="form-input" value="${curFbpn}">
             </div>
             <div class="form-group">
               <label class="form-label">Push Number</label>
               <input id="inputPush" class="form-input" value="${curPush}">
             </div>
          </div>
          
          <div class="input-grid">
             <div class="form-group">
               <label class="form-label">Manufacturer</label>
               <select id="inputMfr" class="form-select">${mfrOpts}</select>
             </div>
             <div class="form-group">
               <label class="form-label">Project</label>
               <select id="inputProj" class="form-select">${projOpts}</select>
             </div>
          </div>

          <div class="count-section">
            <label class="form-label required" style="color:var(--primary); text-align:center; font-size:1rem;">Physical Count</label>
            <input type="number" id="inputCount" class="form-input count-input" placeholder="0" autofocus onkeypress="handleEnter(event)">
          </div>
          
          <div class="button-group">
            <button class="btn btn-secondary" onclick="skipBin()">Skip Bin</button>
            <button class="btn btn-success btn-large" onclick="submitCurrentBin()">Confirm & Next</button>
          </div>
        </div>
      `;
      
      // Auto-focus the count input for speed
      setTimeout(() => {
          const input = document.getElementById('inputCount');
          if(input) input.focus();
      }, 100);
    }

    function submitCurrentBin() {
      const bin = binsQueue[currentIndex];
      const countVal = document.getElementById('inputCount').value;

      if (countVal === '') {
        showAlert('Please enter a count quantity', 'warning');
        return;
      }
      
      const countedQty = parseInt(countVal);
      if (isNaN(countedQty) || countedQty < 0) {
        showAlert('Please enter a valid non-negative number', 'warning');
        return;
      }

      setLoading(true, 'Saving count...');

      const payload = {
        binCode: bin.binCode || bin.Bin_Code,
        
        // System / Original values for reference/variance calc
        originalFbpn: bin.fbpn || bin.FBPN,
        originalManufacturer: bin.manufacturer || bin.Manufacturer,
        originalProject: bin.project || bin.Project,
        currentQty: bin.currentQty !== undefined ? bin.currentQty : (bin.Current_Quantity || 0),
        
        // User inputs
        countedQty: countedQty,
        correctedFbpn: document.getElementById('inputFbpn').value,
        pushNumber: document.getElementById('inputPush').value,
        manufacturer: document.getElementById('inputMfr').value,
        project: document.getElementById('inputProj').value,
        
        timestamp: new Date().toISOString()
      };

      google.script.run
        .withSuccessHandler(function(result) {
          setLoading(false);
          if (result && result.success) {
            showAlert('Count saved', 'success');
            currentIndex++;
            renderCurrentBin();
          } else {
            showAlert('Error submitting count: ' + (result ? result.message : 'Unknown error'), 'danger');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Submit Error:', error);
          setLoading(false);
          showAlert('Server error: ' + error.message, 'danger');
        })
        .imsSubmitCycleCountLine(payload);
    }
    
    function skipBin() {
        currentIndex++;
        renderCurrentBin();
    }

    function handleEnter(event) {
      if (event.key === 'Enter') {
        submitCurrentBin();
      }
    }

    function onFailure(error) {
      console.error('Load Error:', error);
      setLoading(false);
      document.getElementById('binContent').innerHTML = `
        <div class="alert alert-danger">
          <strong>Error loading data:</strong><br>
          ${error.message || error}
          <br><br>
          <button class="btn btn-secondary btn-small" onclick="loadCycleCount()">Try Again</button>
        </div>
      `;
    }

    function setLoading(show, text) {
      const el = document.getElementById('loadingOverlay');
      if (text) document.getElementById('loadingText').textContent = text;
      if (show) el.classList.add('active');
      else el.classList.remove('active');
    }

    function showAlert(msg, type) {
      const div = document.createElement('div');
      div.className = `alert alert-${type}`;
      div.textContent = msg;
      
      const container = document.querySelector('.glass-container');
      const insertPoint = document.querySelector('.summary-section');
      
      if (insertPoint) {
        container.insertBefore(div, insertPoint);
      } else {
        container.prepend(div);
      }
      
      setTimeout(() => div.remove(), 4000);
    }
  </script>
</head>
<body>
  <div class="glass-container">
    <div class="header">
      <h1>Cycle Count</h1>
      <p>Count one bin at a time - navigate through bins following S-route pattern</p>
    </div>

    <div style="padding: 25px;">
      <div class="summary-section">
        <div>
          <div class="summary-label">Currently Counting</div>
          <div class="summary-value" id="currentRows">Initializing...</div>
        </div>
        <button class="btn btn-secondary btn-small" onclick="loadCycleCount()">Restart</button>
      </div>

      <div id="binContent">
        <!-- Bins will be rendered here -->
        <div style="text-align: center; padding: 60px 20px;">
          <p style="color: var(--text-muted);">Waiting for data...</p>
        </div>
      </div>
    </div>
  </div>

  <div id="loadingOverlay" class="loading-overlay active">
    <div class="loading-spinner"></div>
    <div id="loadingText" class="loading-text">Loading bins...</div>
  </div>
</body>
</html>