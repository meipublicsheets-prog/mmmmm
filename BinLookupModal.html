<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('UniversalStyles'); ?>
  <style>
    /* Bin Lookup specific styles */
    .lookup-input-section {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-left: 4px solid var(--primary);
      border-radius: var(--radius-md);
      padding: 24px;
      margin-bottom: 24px;
    }

    .lookup-input-section h3 {
      color: var(--text-main);
      margin-bottom: 16px;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .lookup-input-row {
      display: flex;
      gap: 16px;
      align-items: flex-end;
    }

    .lookup-input-row .form-group {
      flex: 1;
    }

    .lookup-input {
      font-size: 1.1rem;
      font-weight: 500;
      padding: 14px 16px;
    }

    .lookup-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .search-panel {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 20px;
      margin-bottom: 20px;
    }

    .search-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      cursor: pointer;
    }

    .search-panel-header h4 {
      color: var(--text-secondary);
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0;
    }

    .toggle-icon {
      color: var(--text-muted);
      transition: transform 0.2s ease;
    }

    .toggle-icon.expanded {
      transform: rotate(180deg);
    }

    .filter-content {
      display: none;
    }

    .filter-content.active {
      display: block;
    }

    .quick-filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .filter-chip {
      padding: 8px 16px;
      background: var(--bg-body);
      border: 1px solid var(--border-color);
      border-radius: 999px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .filter-chip:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .filter-chip.active {
      background: var(--primary-light);
      color: var(--primary);
      border-color: var(--primary);
    }

    .detail-panel {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 24px;
      margin-top: 20px;
      display: none;
      animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .detail-panel.active {
      display: block;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .detail-item {
      background: var(--bg-body);
      padding: 16px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
      border-left: 3px solid var(--primary);
    }

    .detail-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }

    .detail-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-main);
    }

    .history-timeline {
      margin-top: 20px;
      position: relative;
      padding-left: 20px;
      border-left: 2px solid var(--border-color);
    }

    .history-item {
      position: relative;
      margin-bottom: 20px;
      padding-left: 20px;
    }

    .history-item::before {
      content: '';
      position: absolute;
      left: -25px;
      top: 6px;
      width: 10px;
      height: 10px;
      background: var(--bg-surface);
      border: 2px solid var(--primary);
      border-radius: 50%;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .history-action {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.9rem;
    }

    .history-time {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .history-description {
      font-size: 0.9rem;
      color: var(--text-secondary);
      background: var(--bg-body);
      padding: 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
    }

    .stats-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }

    .stat-box {
      flex: 1;
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
  </style>
  <script>
    let searchResults = [];
    let filtersExpanded = false;

    window.onload = function() {
      loadFilters();
      // Focus on the lookup input
      setTimeout(() => {
        document.getElementById('lookupInput').focus();
      }, 100);
    };

    function handleLookupKeypress(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        performLookup();
      }
    }

    function performLookup() {
      const lookupValue = document.getElementById('lookupInput').value.trim();

      if (!lookupValue) {
        showAlert('Please enter a FBPN or Bin Code', 'warning');
        return;
      }

      showLoading(true, 'Searching...');

      // Search for both FBPN and Bin Code matches
      google.script.run
        .withSuccessHandler(function(results) {
          showLoading(false);
          searchResults = results;
          renderResults(results);
          updateStats(results);

          if (results.length === 1) {
            // Auto-view details if only one result
            viewBinDetails(results[0].binCode);
          } else if (results.length > 0) {
            showAlert(`Found ${results.length} result(s)`, 'success');
          } else {
            showAlert('No results found for: ' + lookupValue, 'warning');
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showAlert('Error: ' + error.message, 'danger');
        })
        .searchBins({ binCode: lookupValue, fbpn: lookupValue });
    }

    function toggleFilters() {
      filtersExpanded = !filtersExpanded;
      const content = document.getElementById('filterContent');
      const icon = document.getElementById('toggleIcon');

      if (filtersExpanded) {
        content.classList.add('active');
        icon.classList.add('expanded');
      } else {
        content.classList.remove('active');
        icon.classList.remove('expanded');
      }
    }

    function loadFilters() {
      google.script.run
        .withSuccessHandler(function(manufacturers) {
          const select = document.getElementById('manufacturerFilter');
          manufacturers.forEach(mfr => {
            const option = document.createElement('option');
            option.value = mfr;
            option.textContent = mfr;
            select.appendChild(option);
          });
        })
        .getManufacturers();

      google.script.run
        .withSuccessHandler(function(projects) {
          const select = document.getElementById('projectFilter');
          projects.forEach(proj => {
            const option = document.createElement('option');
            option.value = proj;
            option.textContent = proj;
            select.appendChild(option);
          });
        })
        .getProjects();
    }

    function performAdvancedSearch() {
      const searchParams = {
        binCode: document.getElementById('binCodeSearch').value,
        fbpn: document.getElementById('fbpnSearch').value,
        manufacturer: document.getElementById('manufacturerFilter').value,
        project: document.getElementById('projectFilter').value,
        stockStatus: document.getElementById('stockStatusFilter').value
      };

      if (!searchParams.binCode && !searchParams.fbpn && !searchParams.manufacturer &&
          !searchParams.project && !searchParams.stockStatus) {
        showAlert('Please enter at least one search criterion', 'warning');
        return;
      }

      showLoading(true, 'Searching...');

      google.script.run
        .withSuccessHandler(function(results) {
          showLoading(false);
          searchResults = results;
          renderResults(results);
          updateStats(results);
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showAlert('Error: ' + error.message, 'danger');
        })
        .searchBins(searchParams);
    }

    function clearSearch() {
      document.getElementById('lookupInput').value = '';
      document.getElementById('binCodeSearch').value = '';
      document.getElementById('fbpnSearch').value = '';
      document.getElementById('manufacturerFilter').value = '';
      document.getElementById('projectFilter').value = '';
      document.getElementById('stockStatusFilter').value = '';
      document.getElementById('resultsContainer').innerHTML = '<div class="empty-state">Enter a FBPN or Bin Code above to search</div>';
      document.getElementById('detailPanel').classList.remove('active');
      document.getElementById('statsBar').innerHTML = '';
      document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
    }

    function renderResults(results) {
      const container = document.getElementById('resultsContainer');

      if (results.length === 0) {
        container.innerHTML = '<div class="empty-state">No results found. Try different search criteria.</div>';
        return;
      }

      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Bin Code</th>
              <th>Bin Name</th>
              <th>FBPN</th>
              <th>Manufacturer</th>
              <th>Project</th>
              <th>Current Qty</th>
              <th>Stock %</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
      `;

      results.forEach(result => {
        const stockStatus = getStockStatus(result.stockPercentage, result.currentQty);
        html += `
          <tr onclick="viewBinDetails('${result.binCode}')" style="cursor: pointer;">
            <td><strong style="color: var(--primary);">${result.binCode}</strong></td>
            <td>${result.binName || '-'}</td>
            <td>${result.fbpn || '<span class="text-muted">Empty</span>'}</td>
            <td>${result.manufacturer || '-'}</td>
            <td>${result.project || '-'}</td>
            <td>${result.currentQty}</td>
            <td>${result.stockPercentage}%</td>
            <td>${stockStatus}</td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function getStockStatus(percentage, currentQty) {
      if (currentQty === 0) {
        return '<span class="badge status-pending">Empty</span>';
      } else if (percentage <= 25) {
        return '<span class="badge status-warning">Low</span>';
      } else if (percentage <= 50) {
        return '<span class="badge status-warning">Medium</span>';
      } else {
        return '<span class="badge status-complete">Stocked</span>';
      }
    }

    function updateStats(results) {
      const statsBar = document.getElementById('statsBar');

      const totalBins = results.length;
      const occupiedBins = results.filter(r => r.currentQty > 0).length;
      const emptyBins = totalBins - occupiedBins;
      const totalQty = results.reduce((sum, r) => sum + (parseInt(r.currentQty) || 0), 0);

      statsBar.innerHTML = `
        <div class="stat-box">
          <div class="stat-value">${totalBins}</div>
          <div class="stat-label">Total Results</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">${occupiedBins}</div>
          <div class="stat-label">Occupied</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">${emptyBins}</div>
          <div class="stat-label">Empty</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">${totalQty.toLocaleString()}</div>
          <div class="stat-label">Total Units</div>
        </div>
      `;
    }

    function viewBinDetails(binCode) {
      showLoading(true, 'Loading bin details...');

      google.script.run
        .withSuccessHandler(function(binItems) {
          showLoading(false);
          displayBinDetails(binCode, binItems);
          loadBinHistory(binCode);
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showAlert('Error: ' + error.message, 'danger');
        })
        .getBinDetails(binCode);
    }

    function displayBinDetails(binCode, binItems) {
      const panel = document.getElementById('detailPanel');
      panel.classList.add('active');
      panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      let html = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="color: var(--text-main); margin: 0; font-size: 1.2rem;">Bin Details: <span style="color: var(--primary);">${binCode}</span></h3>
          <button class="btn btn-secondary btn-small" onclick="closeDetails()">Close</button>
        </div>
      `;

      if (binItems.length === 0 || !binItems[0].fbpn) {
        html += '<div class="empty-state">This bin is currently empty</div>';
      } else {
        const totalQty = binItems.reduce((sum, item) => sum + (parseInt(item.currentQty) || 0), 0);
        const totalInitial = binItems.reduce((sum, item) => sum + (parseInt(item.initialQty) || 0), 0);
        const avgStock = totalInitial > 0 ? Math.round((totalQty / totalInitial) * 100) : 0;

        html += `
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Bin Name</div>
              <div class="detail-value">${binItems[0].binName || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Items</div>
              <div class="detail-value">${binItems.length}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Total Quantity</div>
              <div class="detail-value">${totalQty.toLocaleString()}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Avg Stock %</div>
              <div class="detail-value">${avgStock}%</div>
            </div>
          </div>

          <h4 style="color: var(--text-secondary); margin: 24px 0 12px 0; font-size: 0.9rem;">Items in Bin</h4>
          <table class="data-table">
            <thead>
              <tr>
                <th>FBPN</th>
                <th>Manufacturer</th>
                <th>Project</th>
                <th>Initial Qty</th>
                <th>Current Qty</th>
                <th>Stock %</th>
              </tr>
            </thead>
            <tbody>
        `;

        binItems.forEach(item => {
          const stockStatus = getStockStatus(item.stockPercentage, item.currentQty);
          html += `
            <tr>
              <td><strong style="color: var(--primary);">${item.fbpn}</strong></td>
              <td>${item.manufacturer}</td>
              <td>${item.project}</td>
              <td>${item.initialQty}</td>
              <td>${item.currentQty}</td>
              <td>${item.stockPercentage}% ${stockStatus}</td>
            </tr>
          `;
        });

        html += '</tbody></table>';
      }

      html += '<div id="historyContainer"></div>';
      document.getElementById('detailContent').innerHTML = html;
    }

    function loadBinHistory(binCode) {
      google.script.run
        .withSuccessHandler(function(history) {
          displayBinHistory(history);
        })
        .withFailureHandler(function(error) {
          console.error('Error loading history:', error);
        })
        .getBinHistory(binCode);
    }

    function displayBinHistory(history) {
      const container = document.getElementById('historyContainer');

      if (history.length === 0) {
        container.innerHTML = `
          <h4 style="color: var(--text-secondary); margin: 30px 0 12px 0; font-size: 0.9rem;">Activity History</h4>
          <div class="empty-state">No activity history available</div>
        `;
        return;
      }

      let html = '<h4 style="color: var(--text-secondary); margin: 30px 0 12px 0; font-size: 0.9rem;">Activity History</h4><div class="history-timeline">';

      history.forEach(entry => {
        const date = new Date(entry.timestamp);
        const timeStr = date.toLocaleString();

        html += `
          <div class="history-item">
            <div class="history-header">
              <span class="history-action">${entry.action} - ${entry.fbpn}</span>
              <span class="history-time">${timeStr}</span>
            </div>
            <div class="history-description">${entry.description}</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px;">
              By: ${entry.userEmail} | Qty Changed: ${entry.qtyChanged} | Result: ${entry.resultingQty}
            </div>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
    }

    function closeDetails() {
      document.getElementById('detailPanel').classList.remove('active');
    }

    function applyQuickFilter(filterType) {
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
      });
      event.target.classList.add('active');
      document.getElementById('stockStatusFilter').value = filterType;
      performAdvancedSearch();
    }

    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;

      const container = document.querySelector('.modal-container');
      const header = container.querySelector('.modal-header');
      if (header) {
        header.parentNode.insertBefore(alertDiv, header.nextSibling);
      } else {
        container.prepend(alertDiv);
      }

      setTimeout(() => alertDiv.remove(), 5000);
    }

    function showLoading(show, message = 'Processing...') {
      const overlay = document.getElementById('loadingOverlay');
      const text = document.getElementById('loadingText');
      if (text) text.textContent = message;

      if (show) {
        overlay.classList.add('active');
      } else {
        overlay.classList.remove('active');
      }
    }
  </script>
</head>
<body>
  <div class="modal-container">
    <div class="modal-header">
      <h1>Bin Lookup</h1>
      <p>Search by FBPN or Bin Code</p>
    </div>

    <div style="padding: 25px;">
      <!-- Quick Lookup Input -->
      <div class="lookup-input-section">
        <h3>Quick Lookup</h3>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 16px;">
          Enter a FBPN or Bin Code to search
        </p>
        <div class="lookup-input-row">
          <div class="form-group" style="flex: 2;">
            <input
              type="text"
              id="lookupInput"
              class="form-input lookup-input"
              placeholder="Enter FBPN or Bin Code..."
              onkeypress="handleLookupKeypress(event)"
              autocomplete="off"
            >
          </div>
          <button class="btn btn-primary" onclick="performLookup()">Search</button>
          <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
        </div>
      </div>

      <!-- Advanced Search (Collapsible) -->
      <div class="search-panel">
        <div class="search-panel-header" onclick="toggleFilters()">
          <h4>Advanced Filters</h4>
          <span id="toggleIcon" class="toggle-icon">â–¼</span>
        </div>

        <div id="filterContent" class="filter-content">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Bin Code</label>
              <input type="text" id="binCodeSearch" class="form-input" placeholder="e.g., A1.1">
            </div>

            <div class="form-group">
              <label class="form-label">FBPN</label>
              <input type="text" id="fbpnSearch" class="form-input" placeholder="e.g., FB12345">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Manufacturer</label>
              <select id="manufacturerFilter" class="form-select">
                <option value="">All Manufacturers</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Project</label>
              <select id="projectFilter" class="form-select">
                <option value="">All Projects</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Stock Status</label>
              <select id="stockStatusFilter" class="form-select">
                <option value="">All Status</option>
                <option value="empty">Empty Bins</option>
                <option value="occupied">Occupied Bins</option>
                <option value="low">Low Stock (&lt;25%)</option>
              </select>
            </div>
          </div>

          <div class="quick-filters">
            <span style="color: var(--text-muted); font-size: 0.85rem; margin-right: 8px; align-self: center;">Quick Filters:</span>
            <button class="filter-chip" onclick="applyQuickFilter('empty')">Empty Bins</button>
            <button class="filter-chip" onclick="applyQuickFilter('occupied')">Occupied Bins</button>
            <button class="filter-chip" onclick="applyQuickFilter('low')">Low Stock</button>
          </div>

          <div class="button-group" style="border-top: 1px solid var(--border-color); padding-top: 20px; margin-top: 20px;">
            <button class="btn btn-primary" onclick="performAdvancedSearch()">Apply Filters</button>
          </div>
        </div>
      </div>

      <!-- Stats Bar -->
      <div id="statsBar" class="stats-bar"></div>

      <!-- Results -->
      <div id="resultsContainer">
        <div class="empty-state">Enter a FBPN or Bin Code above to search</div>
      </div>

      <!-- Detail Panel -->
      <div id="detailPanel" class="detail-panel">
        <div id="detailContent"></div>
      </div>
    </div>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div id="loadingText" class="loading-text">Processing...</div>
  </div>
</body>
</html>
